{% extends "base.html" %}

{% block title %}Sources Â· Data Modeller{% endblock %}

{% block content %}
<section>
    <h2>Source Registry</h2>
    <p>Import metadata describing upstream systems and review existing tables and profiling statistics.</p>
</section>

<div class="card-grid">
    <section class="card">
        <header>
            <h3>Import Sources</h3>
            <p class="muted">Submit JSON describing a source system and its tables.</p>
        </header>
        <label for="import-payload" class="visually-hidden">Source import payload</label>
        <textarea id="import-payload" rows="14">{
    "system": {
        "name": "Analytics Warehouse",
        "description": "Demo Snowflake environment",
        "connection_type": "snowflake",
        "connection_config": {"account": "acme"}
    },
    "tables": [
        {
            "schema_name": "PUBLIC",
            "table_name": "ORDERS",
            "columns": [
                {"name": "ORDER_ID", "data_type": "NUMBER", "is_nullable": false},
                {"name": "STATUS", "data_type": "STRING"}
            ]
        }
    ]
}</textarea>
        <button
            type="button"
            hx-post="/api/sources/import"
            hx-vals='js:{ payload: document.getElementById("import-payload").value }'
            hx-target="#source-detail"
            hx-swap="innerHTML"
        >
            Import metadata
        </button>
    </section>

    <section class="card">
        <header>
            <h3>All Sources</h3>
            <p class="muted">Select a table to review the most recent profiling statistics.</p>
        </header>
        {% if sources %}
            <table class="table">
                <thead>
                    <tr>
                        <th scope="col">Source</th>
                        <th scope="col">Table</th>
                        <th scope="col">Row count</th>
                        <th scope="col">Profiled</th>
                        <th scope="col" class="actions">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for source in sources %}
                        {% if source.tables %}
                            {% for table in source.tables %}
                                <tr>
                                    <td data-label="Source">
                                        <strong>{{ source.name }}</strong><br>
                                        <span class="muted">{{ source.connection_type }}</span>
                                    </td>
                                    <td data-label="Table">
                                        {{ table.schema_name }}.{{ table.table_name }}
                                        {% if table.display_name %}
                                            <span class="muted">({{ table.display_name }})</span>
                                        {% endif %}
                                    </td>
                                    <td data-label="Row count">{{ table.row_count or "Unknown" }}</td>
                                    <td data-label="Profiled">{{ table.profiled_at or "Never" }}</td>
                                    <td data-label="Actions">
                                        <button
                                            type="button"
                                            class="secondary"
                                            hx-post="/api/sources/profile"
                                            hx-vals='{"table_id": {{ table.id }}}'
                                            hx-target="#source-detail"
                                            hx-swap="innerHTML"
                                        >
                                            View profile
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td data-label="Source">
                                    <strong>{{ source.name }}</strong>
                                </td>
                                <td colspan="4" class="muted">No tables imported.</td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p class="muted">No sources have been imported.</p>
        {% endif %}
    </section>
</div>

<section id="source-detail" class="card"></section>
{% endblock %}
